---
const API_KEY = import.meta.env.PUBLIC_YOUTUBE_API_KEY;
const { channelId } = Astro.props;

let videoId = null;
let error = null;

try {
  // First get the uploads playlist ID
  const channelRes = await fetch(
    `https://www.googleapis.com/youtube/v3/channels?part=contentDetails&id=${channelId}&key=${API_KEY}`
  );
  const channelData = await channelRes.json();

  if (!channelData.items?.length) {
    throw new Error('Channel not found');
  }

  const uploadsPlaylistId = channelData.items[0].contentDetails.relatedPlaylists.uploads;

  // Get latest video from uploads playlist
  const playlistRes = await fetch(
    `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=1&playlistId=${uploadsPlaylistId}&key=${API_KEY}`
  );
  const playlistData = await playlistRes.json();

  if (!playlistData.items?.length) {
    throw new Error('No videos found');
  }

  videoId = playlistData.items[0].snippet.resourceId.videoId;
} catch (err) {
  error = (err as any).message;
}
---

<!-- Display results -->
{!error && videoId ? (
  <div class="video-container">
    <iframe
      width="560"
      height="315"
      src={`https://www.youtube.com/embed/${videoId}`}
      title="YouTube video player"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
      allowfullscreen
    ></iframe>
  </div>
) : (
  <div class="error">Error loading video: {error}</div>
)}

<style>
  .video-container {
    position: relative;
    padding-bottom: 56.25%;
    height: 0;
    overflow: hidden;
    max-width: 100%;
  }

  .video-container iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }

  .error {
    color: red;
    padding: 1rem;
    border: 1px solid red;
  }
</style>